<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>チャット</title>
    <link rel="stylesheet" href="style.css">
    <style>

        body {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        background: #fffafd;
        }
        .chat-box {
        border: 1.7px solid var(--chat-border);
        border-radius: 16px;
        width: 100%;
        max-width: 520px;
        height: 350px;
        overflow-y: auto;
        background: #fff6fa;
        padding: 14px 11px;
        margin: 20px 0;
        box-shadow: 0 3px 14px #ffe6f0;
        display: flex;
        flex-direction: column;
        gap: 8px;
        }

        .chat-msg {
        max-width: 78%;
        margin-bottom: 8px;
        padding: 11px 17px 7px 14px;
        border-radius: 16px 18px 18px 4px;
        position: relative;
        word-break: break-word;
        font-size: 1.04em;
        background: var(--chat-recv-bg);
        color: var(--chat-recv-text);
        box-shadow: 0 1.3px 4px #ffdbe8;
        display: inline-block;
        align-self: flex-start;
        }

        .chat-msg.me {
        background: var(--chat-sent-bg);
        color: var(--chat-sent-text);
        align-self: flex-end;
        border-radius: 16px 12px 4px 18px;
        box-shadow: 0 1.2px 4px #e8c6df;
        }

        .chat-meta {
        font-size: 0.83em;
        color: #b687a3;
        margin-bottom: 2px;
        display: block;
        }

        /* 入力欄装飾 */
        .chat-input-area {
        display: flex;
        gap: 6px;
        margin-top: 6px;
        }
        #chatInput {
        flex: none;
        width: 220px;
        font-size: 1em;
        padding: 7px 10px;
        border-radius: 10px;
        }
        #chatInput:focus {
        border: 1.6px solid #edbad6;
        }

        /* 送信ボタンも可愛く */
        #chatSend {
        border: none;
        padding: 8px 23px;
        border-radius: 9px;
        background: linear-gradient(90deg, #e06ca0 76%, #edbad6 100%);
        color: #fff;
        font-size: 1.08em;
        font-weight: bold;
        box-shadow: 0 1.5px 7px #ffdbe8;
        cursor: pointer;
        letter-spacing: 1px;
        margin-left: 4px;
        transition: background .17s;
        }

        #chatSend:hover {
        background: linear-gradient(90deg, #edbad6 30%, #e06ca0 100%);
        }

        /* その他ボタンもピンク系 */
        button[onclick*="chat_list.html"], button[onclick*="purchase.html"] {
        margin-right: 12px;
        background: #fff6fa;
        color: #e06ca0;
        border: 1.5px solid #ffdbe8;
        border-radius: 10px;
        font-size: 1.04em;
        padding: 7px 22px;
        box-shadow: 0 1.3px 6px #fedbeb;
        cursor: pointer;
        transition: background 0.12s, color 0.12s, border 0.12s;
        }
        button[onclick*="chat_list.html"]:hover, button[onclick*="purchase.html"]:hover {
        background: #ffe1f3;
        color: #c05397;
        border: 1.5px solid #f7b7d8;
        }
        .button-area {
        display: flex;
        gap: 18px;
        margin-top: 18px;
        justify-content: center;
        align-items: center;
        }
        .button-area button {
        min-width: 180px;
        height: 42px;
        font-size: 1.08em;
        font-family: var(--primary-font);
        padding: 0 18px;
        font-weight: 500;
        box-sizing: border-box;
        }
        /* 商品一覧ボタン専用の強制上書き。style.cssで!importantされているため、ここでも!importantで上書きする */
        .button-area .in-list

    </style>
</head>
<body>
    <h2>出品者とのチャット</h2>
    <div id="productInfo"></div>
    <div class="chat-box" id="chatBox"></div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" maxlength="200" placeholder="メッセージを入力…" style="flex:1;">
        <button id="chatSend">送信</button>
    </div>
<div class="button-area">
    <button onclick="location.href='chat_list.html'">チャットリスト一覧</button>
</div>    <script>
        // ユーザー認証（localStorageにuserid）
        const userid = localStorage.getItem("userid");
        if (!userid) {
            alert("ログインユーザー情報がありません。再ログインしてください。");
            location.href = "login.html";
        }
        // クエリからitemid, price取得
        const params = new URLSearchParams(location.search);
        const itemid = params.get('itemid');
        const price = params.get('price');
        // 商品情報簡易表示
        document.getElementById('productInfo').textContent = `商品番号: ${itemid}　価格: ${price ? Number(price).toLocaleString()+'円' : ""}`;

        // チャットロード
        async function loadChat() {
            const res = await fetch('https://zo7y44s5ih.execute-api.ap-southeast-2.amazonaws.com/hackChat?itemid='+itemid);
            const data = await res.json();
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = '';
            data.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'chat-msg' + (String(msg.senderid) === userid ? ' me' : '');
                div.innerHTML = `<span class="chat-meta">[${msg.username}] ${msg.created_at || ""}</span><br>${msg.message}`;
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        loadChat();

        // メッセージ送信
        document.getElementById('chatSend').onclick = async () => {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return alert('メッセージを入力してください');
            await fetch('https://zo7y44s5ih.execute-api.ap-southeast-2.amazonaws.com/hackChat', {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    itemid: itemid,
                    senderid: userid,
                    message: message
                })
            });
            input.value = "";
            loadChat();
        };

        // 5秒ごとにチャット再取得
        setInterval(loadChat, 5000);

        // キーで送信
        document.getElementById('chatInput').addEventListener('keydown', function(e){
            if(e.key === 'Enter') document.getElementById('chatSend').click();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>商品一覧</title>
    <style>
        body { font-family: sans-serif; background: #f5f5f5; margin: 0; }
        .container { width: 900px; margin: 32px auto; padding: 20px; background:#fff; border-radius:8px;}
        .search-bar { display: flex; gap: 8px; margin-bottom: 32px;}
        .products { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;}
        .item { background: #fff; border: 1px solid #e0e0e0; border-radius:8px; padding: 12px; text-align: center; min-height: 340px; box-shadow:0 1px 4px #e3e3e3;}
        .item img { width: 220px; height: 220px; object-fit: cover; border-radius:5px; background:#fafafa;}
        .itemname { display: block; font-size: 1.25rem; margin: 14px 0 6px; color: #007aff; text-decoration: underline; cursor:pointer;}
        .itemname.sold { color: #999; text-decoration: none; cursor: default;}
        .price { font-size: 1.1rem; color:#555; margin-bottom:6px;}
        .soldout { color: #fff; background: #ee5555; padding: 5px 8px; border-radius: 4px; font-size: 0.95rem; }
        .reset-btn { margin-left: 8px; }
        .dropdown-menu {display: none;position: absolute;top: 40px;right: 10px;background: #fff;box-shadow: 0 0 5px #888;border-radius: 5px;}
        .dropdown-menu.show { display:block; }
        .dropdown-menu a { display:block; padding:8px;}
        .menu-dots { position:absolute; top:10px; right:10px; font-size:32px; cursor:pointer;}
    </style>
</head>

<body>
<div class="menu-dots" onclick="toggleMenu()">&#x22EE;</div>
  <div id="dropdown" class="dropdown-menu">
    <a href="product_list.html">商品一覧</a>
    <a href="add_product.html">商品を出品</a>
    <a href="login.html" onclick="localStorage.removeItem('userid')">ログアウト</a>
  </div>
<div class="container">
    <h1>商品一覧</h1>
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="商品名で検索" value="" style="flex:1; font-size:1.1em; padding:4px 8px;">
        <button id="searchBtn">検索</button>
        <button id="resetBtn" class="reset-btn">リセット</button>
    </div>
    <div id="products" class="products"></div>
    <div id="noResult" style="color:#c00; display:none;">見つかりませんでした</div>
</div>

<script>
const API_URL = 'https://s4ptlhdjid.execute-api.ap-southeast-2.amazonaws.com/hackSearch'; // ←あなたのLambda APIのURLに必ず変更

// ログイン確認
const userid = localStorage.getItem("userid");
if (!userid) {
    alert("ログインユーザー情報がありません。再ログインしてください。");
    location.href = "login.html";
}

function toggleMenu(){
  document.getElementById('dropdown').classList.toggle('show');
}

function createProductHtml(item) {
    const imgUrl = item.image_url; // 画像はS3の静的ホスティングURLパスに合わせる
    const sold = item.buystatus == 1;
    const itemnameClass = sold ? "itemname sold" : "itemname";
    // 商品詳細はitemidをクエリやパスで
    const detailUrl = `/product_detail.html?itemid=${item.itemid}`; // 別ページを想定
    return `
        <div class="item">
            <img src="${imgUrl}" alt="${item.itemname}">
            <div>
                ${
                  sold
                    ? `<span class="${itemnameClass}">${item.itemname}</span>`
                    : `<a href="${detailUrl}" class="${itemnameClass}">${item.itemname}</a>`
                }
            </div>
            <div class="price">￥${item.price.toLocaleString()}</div>
            ${
              sold
                ? `<div class="soldout">SOLD</div>`
                : ""
            }
        </div>
    `;
}

function fetchProducts(keyword='') {
    let url = API_URL;
    if (keyword) url += '?q=' + encodeURIComponent(keyword);
    fetch(url)
    .then(resp => resp.json())
    .then(data => {
        const productsEl = document.getElementById('products');
        if (!data || !Array.isArray(data) || data.length === 0) {
            productsEl.innerHTML = '';
            document.getElementById('noResult').style.display = 'block';
            return;
        }
        document.getElementById('noResult').style.display = 'none';
        productsEl.innerHTML = data.map(createProductHtml).join('');
    })
    .catch(err => {
        alert("エラー：" + err);
    });
}

window.onload = function() {
    fetchProducts();

    document.getElementById('searchBtn').onclick = function() {
        const kw = document.getElementById('searchInput').value.trim();
        fetchProducts(kw);
    }
    document.getElementById('resetBtn').onclick = function() {
        document.getElementById('searchInput').value = '';
        fetchProducts('');
    }
    // Enterキーでも検索
    document.getElementById('searchInput').onkeypress = function(e) {
        if (e.key === 'Enter') document.getElementById('searchBtn').click();
    }
}
</script>
</body>
</html>
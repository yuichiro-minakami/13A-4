<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>商品一覧</title>
    <link rel="stylesheet" href="style.css">
    <style>
    .filter-btn.selected {
      background: #4369d3;
      color: #fff;
    }
    .filter-btn {
      margin-right: 6px;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 4px 18px;
      cursor: pointer;
    }
    .soldout {
      color: #c00;
      font-weight: bold;
    }
    </style>
    <link rel="icon" href="icon.png" type="image/png">
</head>
<body>
<!-- 画面のなるべく中央寄りの上に配置したい場合 -->
<div class="menu-dots" onclick="toggleMenu()">
  <span class="bar"></span>
  <span class="bar"></span>
  <span class="bar"></span>
</div>
<div id="dropdown" class="dropdown-menu">
    <!-- <a href="product_list.html">商品一覧</a> -->
    <a href="add_product.html">商品を出品</a>
    <a href="login.html" onclick="localStorage.removeItem('userid')">ログアウト</a>
</div>
<div class="container">
    <h1>商品一覧</h1>
    <!-- フィルターボタンを検索の上に追加 -->
    <div class="filter-bar" style="margin: 10px 0;">
        <button class="filter-btn" data-bs="">すべて</button>
        <button class="filter-btn" data-bs="0">販売中</button>
        <button class="filter-btn" data-bs="1">購入済み</button>
    </div>
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="商品名で検索" value="" style="flex:1; font-size:1.1em; padding:4px 8px;">
        <button id="searchBtn">検索</button>
        <button id="resetBtn" class="reset-btn">リセット</button>
    </div>
    <div id="products" class="products"></div>
    <div id="noResult" style="color:#c00; display:none;">見つかりませんでした</div>
</div>

<script>
const API_URL = 'https://6047k12ptl.execute-api.ap-southeast-2.amazonaws.com/default/hackFilter';

// ログイン確認
const userid = localStorage.getItem("userid");
if (!userid) {
    alert("ログインユーザー情報がありません。再ログインしてください。");
    location.href = "login.html";
}

function toggleMenu(){
    const menu = document.getElementById('dropdown');
    const btn = document.querySelector('.menu-dots');
    // メニューを出す座標を取得
    const rect = btn.getBoundingClientRect();

    if (!menu.classList.contains('show')) {
        // メニュー位置調整 (rect.right, rect.bottom)
        menu.style.left = rect.right - 150 + "px"; // メニュー幅にあわせてleftを調整
        menu.style.top  = rect.bottom + 6 + "px";
        menu.classList.add('show');
        //他クリックで閉じる
        document.addEventListener('mousedown', closeMenuWhenOutside);
    } else {
        menu.classList.remove('show');
        document.removeEventListener('mousedown', closeMenuWhenOutside);
    }
}

function closeMenuWhenOutside(ev){
    const menu = document.getElementById('dropdown');
    if (!menu.contains(ev.target) && !document.querySelector('.menu-dots').contains(ev.target)) {
        menu.classList.remove('show');
        document.removeEventListener('mousedown', closeMenuWhenOutside);
    }
}

function createProductHtml(item) {
    const imgUrl = item.image_url;
    const sold = item.buystatus == 1;
    const itemnameClass = sold ? "itemname sold" : "itemname";
    
    return `
        <div class="item"
            data-itemid="${item.itemid}" 
            data-sold="${sold}">
            <img src="${imgUrl}" alt="${item.itemname}">
            <div>
                <span class="${itemnameClass}">${item.itemname}</span>
            </div>
            <div class="price">￥${item.price.toLocaleString()}</div>
            ${sold ? `<div class="soldout">SOLD</div>` : ""}
        </div>
    `;
}

// フィルター状態グローバル変数
let nowBuyStatus = ""; // "", "0", "1"

function fetchProducts(keyword='', buystatus='') {
    let url = API_URL;
    let params = [];
    if (keyword) params.push('q=' + encodeURIComponent(keyword));
    if (buystatus !== "" && buystatus !== undefined) params.push('buystatus=' + buystatus);
    if (params.length > 0) url += '?' + params.join('&');
    fetch(url)
    .then(resp => resp.json())
    .then(data => {
        const productsEl = document.getElementById('products');
        if (!data || !Array.isArray(data) || data.length === 0) {
            productsEl.innerHTML = '';
            document.getElementById('noResult').style.display = 'block';
            return;
        }
        document.getElementById('noResult').style.display = 'none';

        data.sort((a, b) => a.buystatus - b.buystatus);

        productsEl.innerHTML = data.map(createProductHtml).join('');

        document.querySelectorAll('.item').forEach(itemDiv => {
            if(itemDiv.dataset.sold !== "true"){
                itemDiv.style.cursor = "pointer";
                itemDiv.addEventListener('click', function(){
                    const itemid = this.dataset.itemid;
                    window.location.href = `/product_detail.html?itemid=${itemid}`;
                });
            }else{
                itemDiv.style.cursor = "default";
            }
        });
    })
    .catch(err => {
        alert("エラー：" + err);
    });
}

window.onload = function() {
    // フィルター(購入/未購入)ボタン制御
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            nowBuyStatus = this.getAttribute('data-bs');
            const kw = document.getElementById('searchInput').value.trim();
            fetchProducts(kw, nowBuyStatus);
        });
    });
    // 初期は「両方」ボタンをactive
    document.querySelector('.filter-btn[data-bs=""]').classList.add('selected');

    fetchProducts();

    document.getElementById('searchBtn').onclick = function() {
        const kw = document.getElementById('searchInput').value.trim();
        fetchProducts(kw, nowBuyStatus);
    }
    document.getElementById('resetBtn').onclick = function() {
        document.getElementById('searchInput').value = '';
        fetchProducts('', nowBuyStatus);
    }
    document.getElementById('searchInput').onkeypress = function(e) {
        if (e.key === 'Enter') document.getElementById('searchBtn').click();
    }
}
</script>
</body>
</html>
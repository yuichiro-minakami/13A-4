<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>商品出品</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
  <style>
    #barcode-reader { width: 300px; }
  </style>
</head>
<body>
  <h2>商品を出品</h2>

  <form id="productForm">
    <label>商品画像: <input type="file" id="image" accept="image/*" required></label><br>
    <label>商品名: <input name="itemname" required></label><br>
    <label>値段: <input name="price" type="number" required></label><br>
    <label>商品説明:<br>
      <textarea name="detail" rows="4" cols="35"></textarea>
    </label><br>

    <label>バーコード写真:
      <input type="file" id="barcodeImage" accept="image/*" required>
    </label>
    <button type="button" id="readBarcodeBtn">バーコード読取</button>
    <span id="itemcode_view"></span>
    <input type="hidden" id="itemcode" name="itemcode">
    <br>
    <button type="submit">出品</button>
  </form>

  <p id="msg"></p>
  <button onclick="location.href='product_list.html'">商品一覧へ戻る</button>

  <img id="previewImg" style="display:none;">

  <script>
    const S3_BUCKET_URL = "https://nes-hack-sample-1304hashigaya.s3.ap-southeast-2.amazonaws.com";
    const api = "https://dsgxgozuji.execute-api.ap-southeast-2.amazonaws.com/default/hackListing";
    const userid = localStorage.getItem("userid");

    if (!userid) {
      alert("ログインユーザー情報がありません。再ログインしてください。");
      location.href = "login.html";
    }

    document.getElementById("readBarcodeBtn").onclick = function(){
      document.getElementById("itemcode_view").innerText = "";
      document.getElementById("itemcode").value = "";

      const file = document.getElementById("barcodeImage").files[0];
      if(!file){
        alert("バーコード画像を選択してください");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const image = new Image();
        image.onload = function() {
          const codeReader = new ZXing.BrowserBarcodeReader();
          codeReader.decodeFromImage(image)
            .then(result => {
              document.getElementById("itemcode_view").innerText = "バーコード値: " + result.text;
              document.getElementById("itemcode").value = result.text;
            })
            .catch(err => {
              document.getElementById("itemcode_view").innerText = "バーコードを検出できませんでした";
            });
        };
        image.src = e.target.result;
      };
      reader.readAsDataURL(file);
    };

    document.getElementById("productForm").onsubmit = async function(e){
      e.preventDefault();
      document.getElementById("msg").innerText = "";
      const file = document.getElementById("image").files[0];
      if(!file){
        document.getElementById("msg").innerText="画像を選択してください";
        return;
      }

      const itemcode = document.getElementById("itemcode").value;
      if(!itemcode){
        document.getElementById("msg").innerText="バーコードの読取を完了してください";
        return;
      }

      const fileName = "product_image_" + Date.now() + "_" + Math.floor(Math.random()*10000) + "." + file.name.split('.').pop();
      const uploadUrl = S3_BUCKET_URL + "/image/" + fileName;
      let uploadRes = await fetch(uploadUrl, {
        method:"PUT",
        body:file,
        headers:{"Content-Type":file.type}
      });
      if(uploadRes.status !== 200 && uploadRes.status !== 201){
        document.getElementById("msg").innerText="画像のアップロードに失敗しました";
        return;
      }

      const form = e.target;
      let body = {
        itemname: form.itemname.value,
        detail: form.detail.value,
        price: parseInt(form.price.value),
        image_url: uploadUrl,
        userid: parseInt(userid),
        itemcode: itemcode
      };
      let res = await fetch(api, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(body)
      });
      let data = await res.json();
      if(data.result==="ok"){
        location.href = "product_list.html";
      }
      else if(data.result==="duplicate"){
        document.getElementById("msg").innerText="このバーコードの商品は既に出品済みです（同じバーコードの商品を複数回は出品できません）";
      }
      else{
        document.getElementById("msg").innerText="商品登録に失敗しました: "+ (data.message || '');
      }
    };
  </script>
</body>
</html>


<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>商品出品</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>商品を出品</h2>
  <form id="productForm">
    <label>商品画像: <input type="file" id="image" accept="image/*" required></label><br>
    <label>商品名: <input name="itemname" required></label><br>
    <label>値段: <input name="price" type="number" required></label><br>
    <label>商品説明:<br>
    <textarea name="detail" rows="4" cols="35"></textarea></label><br>
    <button type="submit">出品</button>
  </form>
  <p id="msg"></p>
  <button onclick="location.href='product_list.html'">商品一覧へ戻る</button>
  <script>
    // S3用設定
    const S3_BUCKET_URL = "https://nes-hack-sample-1304hashigaya.s3.ap-southeast-2.amazonaws.com"; // 例: https://your-bucket.s3.ap-northeast-1.amazonaws.com
    const api = "https://dsgxgozuji.execute-api.ap-southeast-2.amazonaws.com/default/hackListing"; // 例: https://xxx.execute-api.ap-northeast-1.amazonaws.com/prod
    document.getElementById("productForm").onsubmit = async function(e){
      e.preventDefault();
      document.getElementById("msg").innerText = "";
      const file = document.getElementById("image").files[0];
      if(!file){
        document.getElementById("msg").innerText="画像を選択してください";
        return;
      }
      // 1. S3へ画像アップロード（プリサインなし公共バケット前提）
      const fileName = "product_image_" + Date.now() + "_" + Math.floor(Math.random()*10000) + "." + file.name.split('.').pop();
      const uploadUrl = S3_BUCKET_URL + "/image/" + fileName;

      // S3バケットがpublic-writeの場合（テスト用）
      let uploadRes = await fetch(uploadUrl, {method:"PUT",body:file,headers:{"Content-Type":file.type}});
      if(uploadRes.status !== 200 && uploadRes.status !== 201){
        document.getElementById("msg").innerText="画像のアップロードに失敗しました";
        return;
      }

      // 2. Lambda/API Gateway経由でDBに登録
      const form = e.target;
      let body = {
        itemname: form.itemname.value,
        detail: form.detail.value,
        price: parseInt(form.price.value),
        image_url: uploadUrl
      };
      let res = await fetch(api, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(body)
      });
      let data = await res.json();
      if(data.result==="ok"){
        location.href = "product_list.html";
      } else {
        document.getElementById("msg").innerText="商品登録に失敗しました";
      }
    };
  </script>
</body>
</html>